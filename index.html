<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Lead Recovery System - Romina Pipeline</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }

        .sync-status {
            position: absolute;
            top: 10px;
            right: 20px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .sync-online {
            background: #d4edda;
            color: #155724;
        }

        .sync-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
        }

        .tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .today-stats {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Pipeline Compatta Styles */
        .pipeline-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .pipeline-column {
            background: white;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            min-width: 200px;
            max-width: 220px;
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .column-header {
            text-align: center;
            padding: 12px 8px;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
            position: relative;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .column-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
        }

        .column-content::-webkit-scrollbar {
            width: 6px;
        }

        .column-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .column-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .column-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .pipeline-lead {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
            font-size: 0.85em;
        }

        .pipeline-lead:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-color: #3498db;
        }

        .pipeline-lead:active {
            cursor: grabbing;
        }

        .pipeline-lead.dragging {
            opacity: 0.7;
            transform: rotate(3deg) scale(1.02);
            cursor: grabbing;
            z-index: 1000;
        }

        .pipeline-column.drag-over {
            background: #e3f2fd;
            border: 2px dashed #3498db;
            transform: scale(1.01);
        }

        .lead-name {
            font-weight: bold;
            font-size: 0.95em;
            color: #2c3e50;
            margin-bottom: 3px;
        }

        .lead-email {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 2px;
            word-break: break-all;
        }

        .lead-commercial {
            font-size: 0.75em;
            color: #f39c12;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .lead-notes {
            width: 100%;
            margin-top: 5px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.75em;
            resize: none;
            min-height: 40px;
            max-height: 60px;
        }

        .nuovo .column-header { background: #3498db; }
        .non-risponde .column-header { background: #f39c12; }
        .non-risponde-2 .column-header { background: #e67e22; }
        .non-risponde-3 .column-header { background: #d35400; }
        .mai-reperibile .column-header { background: #95a5a6; }
        .non-interessato .column-header { background: #e74c3c; }
        .lead-ok .column-header { background: #27ae60; }

        .column-header .count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: rgba(255,255,255,0.9);
            color: #333;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
        }

        .auto-log {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 3px;
            margin-top: 5px;
            font-size: 0.65em;
            color: #856404;
        }

        .lead-name {
            font-weight: bold;
            font-size: 1em;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .lead-email {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .lead-commercial {
            font-size: 0.8em;
            color: #f39c12;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .lead-timestamp {
            font-size: 0.7em;
            color: #95a5a6;
            border-top: 1px solid #eee;
            padding-top: 5px;
        }

        .lead-notes {
            font-size: 0.8em;
            color: #333;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            margin-top: 5px;
            min-height: 30px;
            resize: none;
        }

        .auto-log {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 5px;
            margin-top: 5px;
            font-size: 0.7em;
            color: #856404;
        }

        /* Lead detail modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .timeline {
            margin-top: 20px;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .timeline-time {
            font-size: 0.8em;
            color: #666;
            min-width: 120px;
        }

        .timeline-content {
            flex: 1;
            margin-left: 15px;
        }

        .timeline-action {
            font-weight: bold;
            color: #2c3e50;
        }

        /* Traditional list view */
        .lead-list {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .search-box {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .filter-btn.nuovo { background: #3498db; color: white; }
        .filter-btn.non-risponde { background: #f39c12; color: white; }
        .filter-btn.non-risponde-2 { background: #e67e22; color: white; }
        .filter-btn.non-risponde-3 { background: #d35400; color: white; }
        .filter-btn.mai-reperibile { background: #95a5a6; color: white; }
        .filter-btn.non-interessato { background: #e74c3c; color: white; }
        .filter-btn.lead-ok { background: #27ae60; color: white; }
        .filter-btn.tutti { background: #34495e; color: white; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-success:hover {
            background: #229954;
        }

        /* Import styles */
        .import-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .import-area:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .import-area.dragover {
            border-color: #27ae60;
            background: #e8f5e8;
        }

        .file-input {
            display: none;
        }

        .report-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }

        .commercial-export-btn {
            transition: all 0.3s ease;
        }

        .commercial-export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .pipeline-container {
                grid-template-columns: repeat(7, 180px);
                overflow-x: auto;
                padding: 0 10px;
            }
            
            .pipeline-column {
                min-width: 180px;
                max-width: 180px;
                height: 500px;
            }
            
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }

            /* Report responsive design */
            div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            div[style*="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"] {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        .hidden {
            display: none;
        }

        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2000;
        }

        .loading.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="sync-status" id="sync-status">üîÑ Connessione...</div>
            <h1>üéØ Lead Recovery System</h1>
            <h2>Dashboard Pipeline Romina - Sistema Condiviso Real-Time</h2>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <h3>üîÑ Sincronizzazione in corso...</h3>
            <p>Caricamento dati dal cloud...</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('pipeline')">üîÑ Pipeline</button>
            <button class="tab" onclick="showTab('dashboard')">üìä Lista Lead</button>
            <button class="tab" onclick="showTab('import')">üì§ Import Lead</button>
            <button class="tab" onclick="showTab('reports')">üìà Report Chiamate</button>
        </div>

        <!-- Pipeline Tab -->
        <div id="pipeline-tab" class="tab-content active">
            <!-- Today Stats -->
            <div class="today-stats">
                <h3>üìä OGGI: <span id="today-calls">0</span> chiamate fatte | <span id="today-ok">0</span> Lead Ok | <span id="today-closed">0</span> Chiusi</h3>
                <p>üí° <strong>Trascina i lead</strong> tra le colonne per cambiare stato - il sistema registra automaticamente orario e data!</p>
                <p>‚òÅÔ∏è <strong>Sincronizzazione Real-Time</strong> - Tutti vedono gli aggiornamenti istantaneamente!</p>
            </div>

            <!-- Pipeline Columns -->
            <div class="pipeline-container" id="pipeline-container">
                <!-- Columns will be generated by JavaScript -->
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <!-- Search and Filters -->
            <div class="lead-list">
                <h3>üìã Lista Lead Tradizionale</h3>
                
                <input type="text" class="search-box" placeholder="üîç Cerca per nome, email o commerciale..." id="search-input">
                
                <div class="filter-buttons">
                    <button class="filter-btn tutti active" onclick="filterLeads('tutti')">Tutti</button>
                    <button class="filter-btn nuovo" onclick="filterLeads('nuovo')">üÜï Nuovo</button>
                    <button class="filter-btn non-risponde" onclick="filterLeads('non-risponde')">üìû Non risponde</button>
                    <button class="filter-btn non-risponde-2" onclick="filterLeads('non-risponde-2')">üìûüìû Non risponde 2</button>
                    <button class="filter-btn non-risponde-3" onclick="filterLeads('non-risponde-3')">üìûüìûüìû Non risponde 3</button>
                    <button class="filter-btn mai-reperibile" onclick="filterLeads('mai-reperibile')">‚ùå Mai reperibile</button>
                    <button class="filter-btn non-interessato" onclick="filterLeads('non-interessato')">üíî Non interessato</button>
                    <button class="filter-btn lead-ok" onclick="filterLeads('lead-ok')">‚úÖ Lead Ok</button>
                </div>

                <!-- Lead Items -->
                <div id="leads-container">
                    <!-- Lead items will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Import Tab -->
        <div id="import-tab" class="tab-content">
            <div class="report-section">
                <h2>üì§ Import Massivo Lead</h2>
                <p style="margin-bottom: 20px;">Carica i tuoi lead da file CSV o Excel. Il sistema riconoscer√† automaticamente le colonne: Nome, Cognome, Telefono, Email.</p>
                
                <div id="import-messages"></div>

                <div class="import-area" id="import-area" onclick="document.getElementById('file-input').click()">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3em; color: #3498db; margin-bottom: 15px;"></i>
                    <h3>üìÅ Trascina qui il tuo file o clicca per selezionare</h3>
                    <p>Supportati: CSV, XLSX, XLS</p>
                    <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
                        Formato atteso: Nome | Cognome | Telefono | Email<br>
                        (le colonne verranno riconosciute automaticamente)
                    </p>
                    <input type="file" id="file-input" class="file-input" accept=".csv,.xlsx,.xls" onchange="handleFileSelect(event)">
                </div>

                <div id="preview-container" style="display: none;">
                    <h3>üëÄ Anteprima Dati</h3>
                    <div id="preview-table" style="margin: 15px 0;"></div>
                    <button class="btn-primary" onclick="confirmImport()">‚úÖ Conferma Import</button>
                    <button class="btn-primary" onclick="cancelImport()" style="background: #e74c3c; margin-top: 10px;">‚ùå Annulla</button>
                </div>

                <div style="margin-top: 30px;">
                    <h3>‚ûï Aggiungi Singolo Lead</h3>
                    <form id="add-lead-form">
                        <div class="form-group">
                            <label>Nome</label>
                            <input type="text" id="nome" required>
                        </div>
                        <div class="form-group">
                            <label>Cognome</label>
                            <input type="text" id="cognome" required>
                        </div>
                        <div class="form-group">
                            <label>Telefono</label>
                            <input type="tel" id="telefono" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="email" required>
                        </div>
                        <button type="submit" class="btn-primary">üöÄ Aggiungi Lead</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content">
            <div class="report-section">
                <h2>üìà Dashboard Report Completo</h2>
                <p style="margin-bottom: 20px;">Monitoraggio performance e attivit√† di Romina con metriche avanzate.</p>
                
                <!-- KPI Dashboard -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;" id="total-leads">0</div>
                        <div style="font-size: 0.9em;">üìä Lead Totali</div>
                    </div>
                    <div style="background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;" id="recovery-rate-percent">0%</div>
                        <div style="font-size: 0.9em;">‚úÖ Tasso Recupero</div>
                    </div>
                    <div style="background: linear-gradient(45deg, #f39c12, #e67e22); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;" id="avg-daily-calls">0</div>
                        <div style="font-size: 0.9em;">üìû Media Chiamate/Giorno</div>
                    </div>
                    <div style="background: linear-gradient(45deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;" id="active-leads">0</div>
                        <div style="font-size: 0.9em;">üî• Lead Attivi</div>
                    </div>
                </div>

                <!-- Three Column Layout -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    
                    <!-- Column 1: Performance Metrics -->
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 10px;">üìä Performance Romina</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>üéØ Lead Recuperati</span>
                                <strong id="recovered-leads">0</strong>
                            </div>
                            <div style="background: #ecf0f1; border-radius: 10px; height: 8px;">
                                <div id="recovery-bar" style="background: #27ae60; height: 8px; border-radius: 10px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>üìû Chiamate Questa Settimana</span>
                                <strong id="week-calls">0</strong>
                            </div>
                            <div style="background: #ecf0f1; border-radius: 10px; height: 8px;">
                                <div id="calls-bar" style="background: #f39c12; height: 8px; border-radius: 10px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>‚è±Ô∏è Tempo Medio Recupero</span>
                                <strong id="avg-recovery-time">0 giorni</strong>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>üèÜ Best Day Performance</span>
                                <strong id="best-day">N/A</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Column 2: Pipeline Status -->
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #e74c3c; padding-bottom: 10px;">üî• Stato Pipeline</h3>
                        
                        <div id="pipeline-stats">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">üí° Insights</h4>
                            <div id="pipeline-insights" style="font-size: 0.9em; color: #666;">
                                <!-- Dynamic insights will be populated -->
                            </div>
                        </div>
                    </div>

                    <!-- Column 3: Weekly Trends -->
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #27ae60; padding-bottom: 10px;">üìà Trend Settimanali</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span>Luned√¨</span>
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 100px; height: 6px; background: #ecf0f1; border-radius: 3px; margin-right: 10px;">
                                        <div id="mon-bar" style="height: 6px; background: #3498db; border-radius: 3px; width: 20%;"></div>
                                    </div>
                                    <span id="mon-calls" style="font-size: 0.8em; color: #666;">5</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span>Marted√¨</span>
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 100px; height: 6px; background: #ecf0f1; border-radius: 3px; margin-right: 10px;">
                                        <div id="tue-bar" style="height: 6px; background: #3498db; border-radius: 3px; width: 45%;"></div>
                                    </div>
                                    <span id="tue-calls" style="font-size: 0.8em; color: #666;">12</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span>Mercoled√¨</span>
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 100px; height: 6px; background: #ecf0f1; border-radius: 3px; margin-right: 10px;">
                                        <div id="wed-bar" style="height: 6px; background: #3498db; border-radius: 3px; width: 80%;"></div>
                                    </div>
                                    <span id="wed-calls" style="font-size: 0.8em; color: #666;">18</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span>Gioved√¨</span>
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 100px; height: 6px; background: #ecf0f1; border-radius: 3px; margin-right: 10px;">
                                        <div id="thu-bar" style="height: 6px; background: #3498db; border-radius: 3px; width: 60%;"></div>
                                    </div>
                                    <span id="thu-calls" style="font-size: 0.8em; color: #666;">15</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span>Venerd√¨</span>
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 100px; height: 6px; background: #ecf0f1; border-radius: 3px; margin-right: 10px;">
                                        <div id="fri-bar" style="height: 6px; background: #3498db; border-radius: 3px; width: 90%;"></div>
                                    </div>
                                    <span id="fri-calls" style="font-size: 0.8em; color: #666;">22</span>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #27ae60;">
                            <div style="font-weight: bold; color: #27ae60; margin-bottom: 5px;">üöÄ Obiettivo Settimanale</div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>80 chiamate</span>
                                <span id="weekly-progress" style="color: #27ae60; font-weight: bold;">72/80</span>
                            </div>
                            <div style="background: #c8e6c9; border-radius: 10px; height: 6px; margin-top: 5px;">
                                <div style="background: #27ae60; height: 6px; border-radius: 10px; width: 90%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Activity Timeline -->
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üìÖ Timeline Attivit√† Giornaliere</h3>
                    <div id="daily-reports">
                        <!-- Daily reports will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Export per Commerciale -->
                <div style="background: linear-gradient(45deg, #27ae60, #2ecc71); border-radius: 12px; padding: 20px; margin-bottom: 30px; color: white;">
                    <h3 style="margin-bottom: 15px; color: white;">üéØ Export Lead per Commerciale</h3>
                    <p style="margin-bottom: 20px; color: rgba(255,255,255,0.9);">Esporta i lead assegnati a ogni commerciale in formato CSV pronto per WhatsApp/Email</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;" id="commercial-export-grid">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Export Actions -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <button class="btn-success" onclick="exportLeadOk()">üì§ Esporta Lead Ok</button>
                    <button class="btn-success" onclick="exportAllLeads()">üìã Esporta Tutti Lead</button>
                    <button class="btn-success" onclick="exportActivityLog()">üìä Esporta Log Attivit√†</button>
                    <button class="btn-success" onclick="exportWeeklyReport()">üìà Esporta Report Settimanale</button>
                </div>

                <!-- Monthly Management -->
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #856404; margin-bottom: 15px;">üóìÔ∏è Gestione Fine Mese</h3>
                    <p style="color: #856404; margin-bottom: 15px;">
                        Strumenti per archiviare i lead completati e preparare il sistema per il nuovo ciclo mensile.
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <button class="btn-primary" onclick="showArchiveOptions()" style="background: #f39c12;">
                            üì¶ Archivia Lead Completati
                        </button>
                        <button class="btn-primary" onclick="showCleanupOptions()" style="background: #e74c3c;">
                            üßπ Pulizia Sistema
                        </button>
                        <button class="btn-primary" onclick="exportMonthlyReport()" style="background: #9b59b6;">
                            üìä Report Mensile Completo
                        </button>
                    </div>
                </div>

                <!-- Archive Modal would be here -->
            </div>
        </div>
    </div>

    <!-- Lead Detail Modal -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-lead-name">Dettagli Lead</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-lead-content">
                <!-- Lead details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Commercial Assignment Modal -->
    <div id="commercialModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>üéØ Assegna Lead Ok</h2>
                <span class="close" onclick="closeCommercialModal()">&times;</span>
            </div>
            <div style="margin-bottom: 20px;">
                <p><strong>Lead recuperato con successo!</strong></p>
                <p id="commercial-lead-name" style="color: #27ae60; font-weight: bold; margin: 10px 0;"></p>
                <p>Scegli il commerciale a cui assegnare questo lead:</p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">üë§ Commerciale:</label>
                <select id="commercial-select" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;">
                    <option value="">Seleziona commerciale</option>
                    <option value="Alessandra Deidda">Alessandra Deidda</option>
                    <option value="Alessandro Poma">Alessandro Poma</option>
                    <option value="Pamela Palmas">Pamela Palmas</option>
                    <option value="Congiu Barbara">Congiu Barbara</option>
                    <option value="Stefano Serra">Stefano Serra</option>
                    <option value="Valerio Pesapane">Valerio Pesapane</option>
                </select>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="confirmCommercialAssignment()" style="background: #27ae60;">
                    ‚úÖ Assegna Lead
                </button>
                <button class="btn-primary" onclick="closeCommercialModal()" style="background: #95a5a6;">
                    ‚ùå Annulla
                </button>
            </div>
        </div>
    </div>

    <!-- Archive Options Modal -->
    <div id="archiveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ Archiviazione Lead Completati</h2>
                <span class="close" onclick="closeArchiveModal()">&times;</span>
            </div>
            <div style="margin-bottom: 20px;">
                <p>Seleziona quali lead completati vuoi archiviare per preparare il sistema al nuovo ciclo:</p>
            </div>
            
            <div id="archive-summary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <!-- Summary will be populated -->
            </div>

            <div style="margin-bottom: 20px;">
                <h4>Opzioni di Archiviazione:</h4>
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" id="archive-lead-ok" checked> 
                    <span style="margin-left: 8px;">‚úÖ Lead Ok (inviati ai commerciali)</span>
                </label>
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" id="archive-non-interessato" checked> 
                    <span style="margin-left: 8px;">üíî Non interessati</span>
                </label>
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" id="archive-mai-reperibile" checked> 
                    <span style="margin-left: 8px;">‚ùå Mai reperibili</span>
                </label>
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" id="export-before-archive" checked> 
                    <span style="margin-left: 8px;">üì§ Esporta prima di archiviare</span>
                </label>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="executeArchive()" style="background: #f39c12;">
                    üì¶ Conferma Archiviazione
                </button>
                <button class="btn-primary" onclick="closeArchiveModal()" style="background: #95a5a6;">
                    ‚ùå Annulla
                </button>
            </div>
        </div>
    </div>

    <!-- Cleanup Options Modal -->
    <div id="cleanupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üßπ Pulizia Sistema</h2>
                <span class="close" onclick="closeCleanupModal()">&times;</span>
            </div>
            <div style="margin-bottom: 20px;">
                <p style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è ATTENZIONE: Queste operazioni sono irreversibili!</p>
                <p>Seleziona cosa vuoi eliminare definitivamente dal sistema:</p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4>Opzioni di Pulizia:</h4>
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" id="cleanup-all-leads"> 
                    <span style="margin-left: 8px;">üóëÔ∏è Elimina TUTTI i lead</span>
                </label>
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" id="cleanup-activity-log"> 
                    <span style="margin-left: 8px;">üìä Pulisci log attivit√†</span>
                </label>
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" id="export-before-cleanup" checked> 
                    <span style="margin-left: 8px;">üì§ Esporta tutto prima di eliminare</span>
                </label>
            </div>

            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="color: #856404;">
                    üí° <strong>Consiglio:</strong> Esegui sempre un backup completo prima della pulizia. 
                    Dopo la pulizia potrai importare i nuovi 1000 lead del mese.
                </p>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="executeCleanup()" style="background: #e74c3c;">
                    üßπ Conferma Pulizia
                </button>
                <button class="btn-primary" onclick="closeCleanupModal()" style="background: #95a5a6;">
                    ‚ùå Annulla
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBuZNxx2eAddnk3yaNH_SSnUPWPjY7pYf8",
            authDomain: "romina-lead-system.firebaseapp.com",
            projectId: "romina-lead-system",
            storageBucket: "romina-lead-system.firebasestorage.app",
            messagingSenderId: "1054691106851",
            appId: "1:1054691106851:web:5ee9846d5f93c184609196"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let leads = [];
        let currentFilter = 'tutti';
        let pendingImportData = null;
        let pendingLeadForCommercial = null;
        let isOnline = true;

        // Status configurations
        const statusConfig = {
            'nuovo': { label: 'üÜï Nuovo', color: '#3498db' },
            'non-risponde': { label: 'üìû Non risponde', color: '#f39c12' },
            'non-risponde-2': { label: 'üìûüìû Non risponde 2', color: '#e67e22' },
            'non-risponde-3': { label: 'üìûüìûüìû Non risponde 3', color: '#d35400' },
            'mai-reperibile': { label: '‚ùå Mai reperibile', color: '#95a5a6' },
            'non-interessato': { label: 'üíî Non interessato', color: '#e74c3c' },
            'lead-ok': { label: '‚úÖ Lead Ok', color: '#27ae60' }
        };

        const commerciali = [
            "Alessandra Deidda",
            "Alessandro Poma", 
            "Pamela Palmas",
            "Congiu Barbara",
            "Stefano Serra",
            "Valerio Pesapane"
        ];

        // Initialize app
        async function initApp() {
            showLoading(true);
            
            try {
                // Set up real-time listener for leads
                const leadsQuery = query(collection(db, 'leads'), orderBy('dataCreazione', 'desc'));
                onSnapshot(leadsQuery, (snapshot) => {
                    leads = [];
                    snapshot.forEach((doc) => {
                        leads.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Update UI
                    renderPipeline();
                    renderLeads();
                    updateSyncStatus(true);
                    showLoading(false);
                }, (error) => {
                    console.error("Error listening to leads:", error);
                    updateSyncStatus(false);
                    showLoading(false);
                });

            } catch (error) {
                console.error("Error initializing app:", error);
                updateSyncStatus(false);
                showLoading(false);
            }
        }

        // Sync status management
        function updateSyncStatus(online) {
            isOnline = online;
            const statusEl = document.getElementById('sync-status');
            
            if (online) {
                statusEl.textContent = '‚úÖ Online - Sincronizzato';
                statusEl.className = 'sync-status sync-online';
            } else {
                statusEl.textContent = '‚ùå Offline - Non sincronizzato';
                statusEl.className = 'sync-status sync-offline';
            }
        }

        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            if (show) {
                loadingEl.classList.add('show');
            } else {
                loadingEl.classList.remove('show');
            }
        }

        // Firebase operations
        async function addLeadToFirebase(leadData) {
            try {
                const docRef = await addDoc(collection(db, 'leads'), {
                    ...leadData,
                    dataCreazione: serverTimestamp(),
                    ultimaModifica: serverTimestamp()
                });
                console.log("Lead added with ID: ", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Error adding lead: ", error);
                throw error;
            }
        }

        async function updateLeadInFirebase(leadId, updates) {
            try {
                const leadRef = doc(db, 'leads', leadId);
                await updateDoc(leadRef, {
                    ...updates,
                    ultimaModifica: serverTimestamp()
                });
                console.log("Lead updated successfully");
            } catch (error) {
                console.error("Error updating lead: ", error);
                throw error;
            }
        }

        async function deleteLeadFromFirebase(leadId) {
            try {
                await deleteDoc(doc(db, 'leads', leadId));
                console.log("Lead deleted successfully");
            } catch (error) {
                console.error("Error deleting lead: ", error);
                throw error;
            }
        }

        // UI Functions
        window.showTab = function(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');

            // Load specific content for each tab
            if (tabName === 'pipeline') {
                renderPipeline();
            } else if (tabName === 'dashboard') {
                renderLeads();
            } else if (tabName === 'reports') {
                renderReports();
            }
        };

        function renderPipeline() {
            const container = document.getElementById('pipeline-container');
            const statusKeys = Object.keys(statusConfig);
            
            container.innerHTML = statusKeys.map(status => {
                const leadsInStatus = leads.filter(lead => lead.stato === status);
                
                return `
                    <div class="pipeline-column ${status}" data-status="${status}" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                        <div class="column-header">
                            ${statusConfig[status].label}
                            <div class="count">${leadsInStatus.length}</div>
                        </div>
                        <div class="column-content">
                            ${leadsInStatus.map(lead => `
                                <div class="pipeline-lead" draggable="true" data-lead-id="${lead.id}" ondragstart="drag(event)" onclick="showLeadDetail('${lead.id}')">
                                    <div class="lead-name">${lead.nome} ${lead.cognome}</div>
                                    <div class="lead-email">üìß ${lead.email}</div>
                                    ${lead.commerciale ? `<div class="lead-commercial">üë§ ${lead.commerciale}</div>` : ''}
                                    <textarea class="lead-notes" placeholder="Note..." onchange="updateLeadNotes('${lead.id}', this.value)" onclick="event.stopPropagation()">${lead.note || ''}</textarea>
                                    ${lead.attivita && lead.attivita.length > 0 ? `
                                        <div class="auto-log">
                                            üïí Ultima: ${formatTimestamp(lead.attivita[lead.attivita.length - 1].timestamp)}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            updateStats();
        }

        function renderLeads() {
            const container = document.getElementById('leads-container');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            let filteredLeads = leads.filter(lead => {
                const matchesFilter = currentFilter === 'tutti' || lead.stato === currentFilter;
                const matchesSearch = searchTerm === '' || 
                    lead.nome.toLowerCase().includes(searchTerm) ||
                    lead.cognome.toLowerCase().includes(searchTerm) ||
                    lead.email.toLowerCase().includes(searchTerm) ||
                    (lead.commerciale && lead.commerciale.toLowerCase().includes(searchTerm));
                
                return matchesFilter && matchesSearch;
            });

            container.innerHTML = filteredLeads.map(lead => `
                <div style="border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-weight: bold; font-size: 1.1em;">${lead.nome} ${lead.cognome}</div>
                        <div style="padding: 4px 12px; border-radius: 15px; font-size: 0.8em; font-weight: bold; color: white; background: ${statusConfig[lead.stato].color}">
                            ${statusConfig[lead.stato].label}
                        </div>
                    </div>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                        üìß ${lead.email}<br>
                        üìû ${lead.telefono || 'N/D'}<br>
                        ${lead.commerciale ? `üë§ Commerciale: ${lead.commerciale}` : 'üë§ <em>Commerciale non assegnato</em>'}
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <label style="font-size: 0.8em;">Assegna:</label>
                        <select onchange="assignCommercial('${lead.id}', this.value)" style="padding: 5px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.8em;">
                            <option value="">Seleziona commerciale</option>
                            ${commerciali.map(comm => `
                                <option value="${comm}" ${lead.commerciale === comm ? 'selected' : ''}>${comm}</option>
                            `).join('')}
                        </select>
                    </div>
                    <textarea style="width: 100%; margin-top: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9em; resize: vertical; min-height: 60px;" placeholder="üí≠ Note per il commerciale..." onchange="updateLeadNotes('${lead.id}', this.value)">${lead.note || ''}</textarea>
                    <button onclick="showLeadDetail('${lead.id}')" style="background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px;">üìã Vedi Timeline</button>
                </div>
            `).join('');

            updateStats();
        }

        function updateStats() {
            // Update today's stats
            const today = new Date().toDateString();
            const todayActivities = leads.flatMap(lead => 
                (lead.attivita || []).filter(a => new Date(a.timestamp).toDateString() === today && a.azione === 'Chiamata effettuata')
            );
            
            document.getElementById('today-calls').textContent = todayActivities.length;
            document.getElementById('today-ok').textContent = todayActivities.filter(a => a.stato === 'lead-ok').length;
            document.getElementById('today-closed').textContent = todayActivities.filter(a => a.stato === 'non-interessato' || a.stato === 'mai-reperibile').length;
        }

        // Drag and drop functions
        window.allowDrop = function(ev) {
            ev.preventDefault();
            if (ev.currentTarget && ev.currentTarget.classList) {
                ev.currentTarget.classList.add('drag-over');
            }
        };

        window.dragLeave = function(ev) {
            if (ev.currentTarget && ev.currentTarget.classList) {
                ev.currentTarget.classList.remove('drag-over');
            }
        };

        window.drag = function(ev) {
            if (ev.target && ev.target.getAttribute) {
                const leadId = ev.target.getAttribute('data-lead-id');
                if (leadId && ev.dataTransfer) {
                    ev.dataTransfer.setData("text", leadId);
                    ev.target.classList.add('dragging');
                }
            }
        };

        window.drop = async function(ev) {
            ev.preventDefault();
            if (ev.currentTarget && ev.currentTarget.classList) {
                ev.currentTarget.classList.remove('drag-over');
            }
            
            if (ev.dataTransfer) {
                const leadId = ev.dataTransfer.getData("text");
                const newStatus = ev.currentTarget.getAttribute('data-status');
                const lead = leads.find(l => l.id === leadId);
                
                if (lead && lead.stato !== newStatus && newStatus) {
                    // Se il nuovo stato √® "lead-ok", apri il modal per assegnare il commerciale
                    if (newStatus === 'lead-ok') {
                        pendingLeadForCommercial = { leadId: leadId, oldStatus: lead.stato, newStatus: newStatus };
                        showCommercialModal(lead);
                        
                        // Remove dragging class
                        document.querySelectorAll('.pipeline-lead').forEach(el => {
                            if (el.classList) {
                                el.classList.remove('dragging');
                            }
                        });
                        return;
                    }
                    
                    // Per tutti gli altri stati, procedi normalmente
                    await updateLeadStatus(leadId, newStatus);
                }
            }
            
            // Remove dragging class from all elements
            document.querySelectorAll('.pipeline-lead').forEach(el => {
                if (el.classList) {
                    el.classList.remove('dragging');
                }
            });
        };

        async function updateLeadStatus(leadId, newStatus) {
            const lead = leads.find(l => l.id === leadId);
            if (lead) {
                try {
                    // Add automatic activity log
                    const now = new Date();
                    const dettagli = `Cambiato stato da "${statusConfig[lead.stato].label}" a "${statusConfig[newStatus].label}" - ${formatTime(now)}`;
                    
                    const newAttivita = (lead.attivita || []).concat([{
                        azione: 'Chiamata effettuata',
                        stato: newStatus,
                        timestamp: now.toISOString(),
                        automatico: true,
                        dettagli: dettagli
                    }]);
                    
                    await updateLeadInFirebase(leadId, {
                        stato: newStatus,
                        ultimaChiamata: now.toISOString(),
                        attivita: newAttivita
                    });
                    
                } catch (error) {
                    console.error('Error updating lead status:', error);
                    alert('Errore nell\'aggiornamento del lead. Riprova.');
                }
            }
        }

        function formatTime(date) {
            return date.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return `${date.toLocaleDateString('it-IT')} ${date.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}`;
        }

        window.showLeadDetail = function(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;

            document.getElementById('modal-lead-name').textContent = `${lead.nome} ${lead.cognome}`;
            
            const modalContent = `
                <div style="margin-bottom: 20px;">
                    <p><strong>üìß Email:</strong> ${lead.email}</p>
                    <p><strong>üìû Telefono:</strong> ${lead.telefono || 'Non disponibile'}</p>
                    <p><strong>üë§ Commerciale:</strong> ${lead.commerciale || 'Non assegnato'}</p>
                    <p><strong>üìä Stato attuale:</strong> <span style="background: ${statusConfig[lead.stato].color}; color: white; padding: 4px 8px; border-radius: 4px;">${statusConfig[lead.stato].label}</span></p>
                    <p><strong>üìù Note:</strong> ${lead.note || 'Nessuna nota'}</p>
                </div>
                
                <div class="timeline">
                    <h4>üìà Timeline Attivit√†</h4>
                    ${(lead.attivita || []).slice().reverse().map(attivita => `
                        <div class="timeline-item" style="border-left-color: ${statusConfig[attivita.stato].color}">
                            <div class="timeline-time">
                                ${formatTimestamp(attivita.timestamp)}
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-action">${attivita.azione}</div>
                                <div style="color: #666; font-size: 0.9em;">${attivita.dettagli}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('modal-lead-content').innerHTML = modalContent;
            document.getElementById('leadModal').style.display = 'block';
        };

        window.closeModal = function() {
            document.getElementById('leadModal').style.display = 'none';
        };

        // Commercial Assignment Modal Functions
        function showCommercialModal(lead) {
            document.getElementById('commercial-lead-name').textContent = `${lead.nome} ${lead.cognome} - ${lead.email}`;
            document.getElementById('commercial-select').value = lead.commerciale || '';
            document.getElementById('commercialModal').style.display = 'block';
        }

        window.closeCommercialModal = function() {
            document.getElementById('commercialModal').style.display = 'none';
            pendingLeadForCommercial = null;
        };

        window.confirmCommercialAssignment = async function() {
            const selectedCommercial = document.getElementById('commercial-select').value;
            
            if (!selectedCommercial) {
                alert('‚ö†Ô∏è Seleziona un commerciale prima di procedere!');
                return;
            }

            if (pendingLeadForCommercial) {
                const lead = leads.find(l => l.id === pendingLeadForCommercial.leadId);
                if (lead) {
                    try {
                        // Aggiorna lo stato a lead-ok
                        const now = new Date();
                        const dettagli = `Lead recuperato con successo e assegnato a ${selectedCommercial} - ${formatTime(now)}`;
                        
                        const newAttivita = (lead.attivita || []).concat([{
                            azione: 'Lead recuperato',
                            stato: 'lead-ok',
                            timestamp: now.toISOString(),
                            automatico: true,
                            dettagli: dettagli
                        }]);
                        
                        await updateLeadInFirebase(pendingLeadForCommercial.leadId, {
                            commerciale: selectedCommercial,
                            stato: 'lead-ok',
                            ultimaChiamata: now.toISOString(),
                            attivita: newAttivita
                        });
                        
                        // Chiudi il modal
                        closeCommercialModal();
                        
                        // Mostra messaggio di successo
                        alert(`‚úÖ Lead "${lead.nome} ${lead.cognome}" assegnato con successo a ${selectedCommercial}!`);
                        
                    } catch (error) {
                        console.error('Error assigning commercial:', error);
                        alert('Errore nell\'assegnazione del commerciale. Riprova.');
                    }
                }
            }
        };

        window.updateLeadNotes = async function(leadId, notes) {
            const lead = leads.find(l => l.id === leadId);
            if (lead) {
                try {
                    const updates = { note: notes };
                    
                    if (notes.trim()) {
                        const newAttivita = (lead.attivita || []).concat([{
                            azione: 'Nota aggiunta',
                            stato: lead.stato,
                            timestamp: new Date().toISOString(),
                            automatico: true,
                            dettagli: `Nota aggiunta: "${notes.substring(0, 50)}${notes.length > 50 ? '...' : ''}"`
                        }]);
                        
                        updates.attivita = newAttivita;
                    }
                    
                    await updateLeadInFirebase(leadId, updates);
                } catch (error) {
                    console.error('Error updating notes:', error);
                }
            }
        };

        window.assignCommercial = async function(leadId, commercial) {
            const lead = leads.find(l => l.id === leadId);
            if (lead) {
                try {
                    const oldCommercial = lead.commerciale;
                    const updates = { commerciale: commercial };
                    
                    if (commercial && commercial !== oldCommercial) {
                        const newAttivita = (lead.attivita || []).concat([{
                            azione: 'Commerciale assegnato',
                            stato: lead.stato,
                            timestamp: new Date().toISOString(),
                            automatico: true,
                            dettagli: `Commerciale assegnato: ${commercial}${oldCommercial ? ` (precedente: ${oldCommercial})` : ''}`
                        }]);
                        
                        updates.attivita = newAttivita;
                    }
                    
                    await updateLeadInFirebase(leadId, updates);
                } catch (error) {
                    console.error('Error assigning commercial:', error);
                }
            }
        };

        window.filterLeads = function(filter) {
            currentFilter = filter;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderLeads();
        };

        window.addNewLead = async function() {
            try {
                const newLead = {
                    nome: document.getElementById('nome').value,
                    cognome: document.getElementById('cognome').value,
                    telefono: document.getElementById('telefono').value,
                    email: document.getElementById('email').value,
                    commerciale: '',
                    stato: 'nuovo',
                    note: '',
                    ultimaChiamata: null,
                    attivita: [{
                        azione: 'Creazione lead',
                        stato: 'nuovo',
                        timestamp: new Date().toISOString(),
                        automatico: true,
                        dettagli: 'Lead creato manualmente nel sistema'
                    }]
                };

                await addLeadToFirebase(newLead);
                document.getElementById('add-lead-form').reset();
                
            } catch (error) {
                console.error('Error adding lead:', error);
                alert('Errore nell\'aggiunta del lead. Riprova.');
            }
        };

        // File import functions 
        window.handleFileSelect = function(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        };

        function processFile(file) {
            const reader = new FileReader();
            const fileExtension = file.name.split('.').pop().toLowerCase();

            reader.onload = function(e) {
                try {
                    let data;
                    
                    if (fileExtension === 'csv') {
                        data = parseCSV(e.target.result);
                    } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                        data = parseExcel(e.target.result);
                    } else {
                        showMessage('Formato file non supportato. Usa CSV, XLSX o XLS.', 'error');
                        return;
                    }

                    if (data && data.length > 0) {
                        showPreview(data);
                    } else {
                        showMessage('Nessun dato trovato nel file.', 'error');
                    }
                } catch (error) {
                    showMessage('Errore nella lettura del file: ' + error.message, 'error');
                }
            };

            if (fileExtension === 'csv') {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });

                const mappedRow = {
                    nome: '',
                    cognome: '',
                    telefono: '',
                    email: ''
                };

                Object.keys(row).forEach(key => {
                    const cleanKey = key.toLowerCase().trim();
                    const value = row[key];
                    
                    if (cleanKey === 'nome' || cleanKey === 'name' || cleanKey === 'first') {
                        mappedRow.nome = value;
                    } else if (cleanKey === 'cognome' || cleanKey === 'surname' || cleanKey === 'last') {
                        mappedRow.cognome = value;
                    } else if (cleanKey === 'telefono' || cleanKey === 'phone' || cleanKey === 'tel') {
                        mappedRow.telefono = value;
                    } else if (cleanKey === 'email' || cleanKey === 'mail') {
                        mappedRow.email = value;
                    }
                });

                if (mappedRow.nome || mappedRow.cognome || mappedRow.email || mappedRow.telefono) {
                    data.push(mappedRow);
                }
            }

            return data;
        }

        function parseExcel(arrayBuffer) {
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            return jsonData.map(row => {
                const mappedRow = {
                    nome: '',
                    cognome: '',
                    telefono: '',
                    email: ''
                };

                Object.keys(row).forEach(originalKey => {
                    const cleanKey = originalKey.trim().toLowerCase();
                    const value = row[originalKey];
                    
                    if (cleanKey === 'nome') {
                        mappedRow.nome = value;
                    } else if (cleanKey === 'cognome') {
                        mappedRow.cognome = value;
                    } else if (cleanKey === 'telefono') {
                        mappedRow.telefono = value ? value.toString() : '';
                    } else if (cleanKey === 'email') {
                        mappedRow.email = value;
                    }
                });

                return mappedRow;
            }).filter(row => row.nome || row.cognome || row.email || row.telefono);
        }

        function showPreview(data) {
            pendingImportData = data;
            const previewContainer = document.getElementById('preview-container');
            const previewTable = document.getElementById('preview-table');

            const previewData = data.slice(0, 5);
            
            let tableHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; border: 1px solid #ddd;">Nome</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Cognome</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Telefono</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Email</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            previewData.forEach(row => {
                tableHTML += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${row.nome || ''}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${row.cognome || ''}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${row.telefono || ''}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${row.email || ''}</td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 10px; color: #666;">
                    Showing first 5 rows of ${data.length} total records.
                </p>
            `;

            previewTable.innerHTML = tableHTML;
            previewContainer.style.display = 'block';
        }

        window.confirmImport = async function() {
            if (pendingImportData && pendingImportData.length > 0) {
                showLoading(true);
                let importedCount = 0;
                
                try {
                    for (const row of pendingImportData) {
                        if (row.email && !leads.find(l => l.email === row.email)) {
                            const newLead = {
                                nome: row.nome || '',
                                cognome: row.cognome || '',
                                telefono: row.telefono || '',
                                email: row.email,
                                commerciale: '',
                                stato: 'nuovo',
                                note: '',
                                ultimaChiamata: null,
                                attivita: [{
                                    azione: 'Creazione lead',
                                    stato: 'nuovo',
                                    timestamp: new Date().toISOString(),
                                    automatico: true,
                                    dettagli: 'Lead importato da file CSV/Excel'
                                }]
                            };
                            
                            await addLeadToFirebase(newLead);
                            importedCount++;
                        }
                    }

                    showMessage(`‚úÖ Importati con successo ${importedCount} nuovi lead!`, 'success');
                    cancelImport();
                    
                } catch (error) {
                    console.error('Error importing leads:', error);
                    showMessage('Errore durante l\'importazione. Riprova.', 'error');
                } finally {
                    showLoading(false);
                }
            }
        };

        window.cancelImport = function() {
            pendingImportData = null;
            document.getElementById('preview-container').style.display = 'none';
            document.getElementById('file-input').value = '';
        };

        function showMessage(message, type) {
            const messagesContainer = document.getElementById('import-messages');
            const messageClass = type === 'error' ? 'error-message' : 'success-message';
            
            messagesContainer.innerHTML = `<div class="${messageClass}">${message}</div>`;
            
            setTimeout(() => {
                messagesContainer.innerHTML = '';
            }, 5000);
        }

        // Reports functions
        function renderReports() {
            const reportsContainer = document.getElementById('daily-reports');
            
            // Calculate KPIs
            const totalLeads = leads.length;
            const recoveredLeads = leads.filter(lead => lead.stato === 'lead-ok').length;
            const recoveryRate = totalLeads > 0 ? Math.round((recoveredLeads / totalLeads) * 100) : 0;
            const activeLeads = leads.filter(lead => !['lead-ok', 'non-interessato', 'mai-reperibile'].includes(lead.stato)).length;
            
            // Update KPI displays
            document.getElementById('total-leads').textContent = totalLeads;
            document.getElementById('recovery-rate-percent').textContent = recoveryRate + '%';
            document.getElementById('recovered-leads').textContent = recoveredLeads;
            document.getElementById('active-leads').textContent = activeLeads;
            
            // Render Commercial Export Grid
            renderCommercialExportGrid();
            
            // Calculate daily call average
            const allActivities = leads.flatMap(lead => 
                (lead.attivita || []).filter(a => a.azione === 'Chiamata effettuata')
            );
            const daysWithCalls = new Set(allActivities.map(a => new Date(a.timestamp).toDateString())).size;
            const avgDailyCalls = daysWithCalls > 0 ? Math.round(allActivities.length / daysWithCalls) : 0;
            document.getElementById('avg-daily-calls').textContent = avgDailyCalls;
            
            // Update progress bars
            document.getElementById('recovery-bar').style.width = recoveryRate + '%';
            document.getElementById('calls-bar').style.width = Math.min(100, (allActivities.length / 100) * 100) + '%';
            document.getElementById('week-calls').textContent = allActivities.filter(a => {
                const activityDate = new Date(a.timestamp);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return activityDate >= weekAgo;
            }).length;
            
            // Calculate average recovery time
            const recoveredWithDates = leads.filter(lead => lead.stato === 'lead-ok' && (lead.attivita || []).length > 1);
            const avgRecoveryDays = recoveredWithDates.length > 0 ? 
                Math.round(recoveredWithDates.reduce((sum, lead) => {
                    const created = new Date(lead.dataCreazione?.seconds ? lead.dataCreazione.seconds * 1000 : lead.dataCreazione);
                    const recovered = new Date((lead.attivita || []).find(a => a.stato === 'lead-ok')?.timestamp || lead.dataCreazione);
                    return sum + (recovered - created) / (1000 * 60 * 60 * 24);
                }, 0) / recoveredWithDates.length) : 0;
            document.getElementById('avg-recovery-time').textContent = avgRecoveryDays + ' giorni';
            
            // Pipeline Stats
            const pipelineStatsContainer = document.getElementById('pipeline-stats');
            let pipelineHTML = '';
            Object.keys(statusConfig).forEach(status => {
                const count = leads.filter(lead => lead.stato === status).length;
                const percentage = totalLeads > 0 ? Math.round((count / totalLeads) * 100) : 0;
                pipelineHTML += `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 0.9em;">${statusConfig[status].label}</span>
                            <strong>${count} (${percentage}%)</strong>
                        </div>
                        <div style="background: #ecf0f1; border-radius: 10px; height: 6px;">
                            <div style="background: ${statusConfig[status].color}; height: 6px; border-radius: 10px; width: ${percentage}%;"></div>
                        </div>
                    </div>
                `;
            });
            pipelineStatsContainer.innerHTML = pipelineHTML;
            
            // Pipeline Insights
            const insightsContainer = document.getElementById('pipeline-insights');
            let insights = [];
            
            if (leads.filter(lead => lead.stato === 'nuovo').length > 20) {
                insights.push('üéØ Molti lead nuovi da processare');
            }
            if (recoveryRate > 15) {
                insights.push('üöÄ Ottimo tasso di recupero!');
            } else if (recoveryRate < 5) {
                insights.push('‚ö†Ô∏è Tasso recupero basso, ottimizzare approach');
            }
            if (leads.filter(lead => lead.stato === 'non-risponde-3').length > 10) {
                insights.push('üìû Molti lead al 3¬∞ tentativo, considerare strategie alternative');
            }
            
            insightsContainer.innerHTML = insights.length > 0 ? insights.join('<br>') : '‚úÖ Tutto sotto controllo';
            
            // Find best performance day
            const dailyStats = {};
            allActivities.forEach(activity => {
                const date = new Date(activity.timestamp).toDateString();
                if (!dailyStats[date]) dailyStats[date] = 0;
                dailyStats[date]++;
            });
            
            const bestDay = Object.keys(dailyStats).reduce((best, date) => 
                (!best || dailyStats[date] > dailyStats[best]) ? date : best, null
            );
            
            if (bestDay) {
                const bestDayFormatted = new Date(bestDay).toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'short' });
                document.getElementById('best-day').textContent = `${bestDayFormatted} (${dailyStats[bestDay]} chiamate)`;
            }
            
            // Daily activity report
            const activityByDate = {};
            leads.flatMap(lead => 
                (lead.attivita || []).map(activity => ({
                    ...activity,
                    leadName: `${lead.nome} ${lead.cognome}`,
                    leadEmail: lead.email
                }))
            ).forEach(activity => {
                const date = new Date(activity.timestamp).toDateString();
                if (!activityByDate[date]) {
                    activityByDate[date] = [];
                }
                activityByDate[date].push(activity);
            });

            // Show last 5 days
            const reportHTML = Object.keys(activityByDate)
                .sort((a, b) => new Date(b) - new Date(a))
                .slice(0, 5)
                .map(date => {
                    const activities = activityByDate[date];
                    const calls = activities.filter(a => a.azione === 'Chiamata effettuata');
                    
                    return `
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #3498db;">
                            <h4>${new Date(date).toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}</h4>
                            <p style="margin: 10px 0; color: #666;">
                                üìû <strong>${calls.length} chiamate</strong> ‚Ä¢ 
                                ‚úÖ <strong>${calls.filter(c => c.stato === 'lead-ok').length} Lead Ok</strong> ‚Ä¢ 
                                üíî <strong>${calls.filter(c => c.stato === 'non-interessato' || c.stato === 'mai-reperibile').length} Chiusi</strong>
                            </p>
                            <div style="max-height: 200px; overflow-y: auto; margin-top: 15px;">
                                ${activities.slice(0, 8).map(activity => `
                                    <div style="padding: 5px 0; border-bottom: 1px solid #eee; font-size: 0.8em;">
                                        <span style="color: #666;">
                                            ${formatTimestamp(activity.timestamp)}
                                        </span> - <strong>${activity.azione}</strong> - ${activity.leadName}
                                    </div>
                                `).join('')}
                                ${activities.length > 8 ? `<div style="padding: 5px 0; text-align: center; color: #666; font-size: 0.8em;">...e altre ${activities.length - 8} attivit√†</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            reportsContainer.innerHTML = reportHTML || '<p>Nessuna attivit√† registrata negli ultimi 5 giorni.</p>';
        }

        function renderCommercialExportGrid() {
            const commercialGrid = document.getElementById('commercial-export-grid');
            
            let gridHTML = '';
            commerciali.forEach(commerciale => {
                const leadPerCommerciale = leads.filter(lead => lead.commerciale === commerciale);
                const leadOkCount = leadPerCommerciale.filter(lead => lead.stato === 'lead-ok').length;
                const totalCount = leadPerCommerciale.length;
                
                gridHTML += `
                    <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 15px; backdrop-filter: blur(10px);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: white;">${commerciale}</h4>
                            <div style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">
                                <strong>${leadOkCount}</strong> Lead Ok
                            </div>
                        </div>
                        <div style="margin-bottom: 10px; font-size: 0.9em; color: rgba(255,255,255,0.8);">
                            Totale assegnati: <strong>${totalCount}</strong>
                        </div>
                        <button onclick="exportForCommercial('${commerciale}')" 
                                style="width: 100%; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;"
                                onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                                onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            üì§ Esporta Lead Ok
                        </button>
                        ${totalCount > 0 ? `
                            <button onclick="exportAllForCommercial('${commerciale}')" 
                                    style="width: 100%; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-top: 5px; font-size: 0.8em; transition: all 0.3s ease;"
                                    onmouseover="this.style.background='rgba(255,255,255,0.2)'"
                                    onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                                üìã Esporta Tutti i Lead
                            </button>
                        ` : ''}
                    </div>
                `;
            });
            
            commercialGrid.innerHTML = gridHTML;
        }

        window.exportForCommercial = function(commerciale) {
            const leadOkForCommercial = leads.filter(lead => 
                lead.commerciale === commerciale && lead.stato === 'lead-ok'
            );
            
            if (leadOkForCommercial.length === 0) {
                alert(`‚ö†Ô∏è Nessun Lead Ok trovato per ${commerciale}`);
                return;
            }
            
            const csv = `LEAD OK PER ${commerciale.toUpperCase()} - ${new Date().toLocaleDateString()}\n\n` +
                       `Nome,Cognome,Telefono,Email,Note,Data Recupero,Ora Recupero\n` + 
                       leadOkForCommercial.map(lead => {
                           const dataRecupero = (lead.attivita || []).find(a => a.stato === 'lead-ok')?.timestamp || '';
                           const dateObj = dataRecupero ? new Date(dataRecupero) : new Date();
                           return `${lead.nome},${lead.cognome},${lead.telefono || ''},${lead.email},"${lead.note || ''}",${dateObj.toLocaleDateString()},${dateObj.toLocaleTimeString()}`;
                       }).join('\n') + 
                       `\n\nüìä RIEPILOGO:\n` +
                       `Totale Lead Ok: ${leadOkForCommercial.length}\n` +
                       `Commerciale: ${commerciale}\n` +
                       `Data Export: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}\n` +
                       `\nüí° PROSSIMI PASSI:\n` +
                       `1. Contattare i lead entro 24h\n` +
                       `2. Aggiornare il CRM con gli esiti\n` +
                       `3. Preparare documentazione per clienti interessati`;
            
            downloadCSV(csv, `lead-ok-${commerciale.replace(' ', '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.csv`);
            
            // Mostra messaggio di successo con istruzioni
            alert(`‚úÖ Export completato per ${commerciale}!\n\nüìä ${leadOkForCommercial.length} Lead Ok esportati\n\nüí° Il file √® pronto per essere inviato via WhatsApp o Email al commerciale.`);
        };

        window.exportAllForCommercial = function(commerciale) {
            const allLeadsForCommercial = leads.filter(lead => lead.commerciale === commerciale);
            
            if (allLeadsForCommercial.length === 0) {
                alert(`‚ö†Ô∏è Nessun lead trovato per ${commerciale}`);
                return;
            }
            
            const csv = `TUTTI I LEAD PER ${commerciale.toUpperCase()} - ${new Date().toLocaleDateString()}\n\n` +
                       `Nome,Cognome,Telefono,Email,Stato,Note,Data Assegnazione,Ultima Attivit√†\n` + 
                       allLeadsForCommercial.map(lead => {
                           const ultimaAttivita = (lead.attivita || []).length > 0 ? 
                               new Date((lead.attivita || [])[lead.attivita.length - 1].timestamp).toLocaleDateString() : 'N/A';
                           const dataCreazione = lead.dataCreazione?.seconds ? 
                               new Date(lead.dataCreazione.seconds * 1000).toLocaleDateString() : 
                               new Date(lead.dataCreazione).toLocaleDateString();
                           return `${lead.nome},${lead.cognome},${lead.telefono || ''},${lead.email},${statusConfig[lead.stato].label},"${lead.note || ''}",${dataCreazione},${ultimaAttivita}`;
                       }).join('\n') + 
                       `\n\nüìä RIEPILOGO PER ${commerciale}:\n` +
                       `Totale Lead: ${allLeadsForCommercial.length}\n` +
                       `Lead Ok: ${allLeadsForCommercial.filter(l => l.stato === 'lead-ok').length}\n` +
                       `In Lavorazione: ${allLeadsForCommercial.filter(l => !['lead-ok', 'non-interessato', 'mai-reperibile'].includes(l.stato)).length}\n` +
                       `Chiusi: ${allLeadsForCommercial.filter(l => l.stato === 'non-interessato' || l.stato === 'mai-reperibile').length}\n` +
                       `Data Export: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;
            
            downloadCSV(csv, `tutti-lead-${commerciale.replace(' ', '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.csv`);
            
            alert(`‚úÖ Export completo per ${commerciale}!\n\nüìä ${allLeadsForCommercial.length} lead totali esportati`);
        };

        // Export functions
        window.exportLeadOk = function() {
            const leadOk = leads.filter(lead => lead.stato === 'lead-ok');
            const csv = 'Nome,Cognome,Telefono,Email,Commerciale,Note,Data Recupero\n' + 
                       leadOk.map(lead => {
                           const dataRecupero = (lead.attivita || []).find(a => a.stato === 'lead-ok')?.timestamp || '';
                           return `${lead.nome},${lead.cognome},${lead.telefono || ''},${lead.email},${lead.commerciale || ''},"${lead.note || ''}",${new Date(dataRecupero).toLocaleDateString()}`;
                       }).join('\n');
            
            downloadCSV(csv, `lead-ok-${new Date().toISOString().split('T')[0]}.csv`);
        };

        window.exportAllLeads = function() {
            const csv = 'Nome,Cognome,Telefono,Email,Commerciale,Stato,Note,Data Creazione\n' + 
                       leads.map(lead => {
                           const dataCreazione = lead.dataCreazione?.seconds ? 
                               new Date(lead.dataCreazione.seconds * 1000).toLocaleDateString() : 
                               new Date(lead.dataCreazione).toLocaleDateString();
                           return `${lead.nome},${lead.cognome},${lead.telefono || ''},${lead.email},${lead.commerciale || ''},${lead.stato},"${lead.note || ''}",${dataCreazione}`;
                       }).join('\n');
            
            downloadCSV(csv, `tutti-lead-${new Date().toISOString().split('T')[0]}.csv`);
        };

        window.exportActivityLog = function() {
            const allActivities = leads.flatMap(lead => 
                (lead.attivita || []).map(activity => ({
                    ...activity,
                    leadName: `${lead.nome} ${lead.cognome}`,
                    leadEmail: lead.email
                }))
            );

            const csv = 'Data,Ora,Lead,Email,Azione,Stato,Dettagli\n' + 
                       allActivities.map(activity => {
                           const date = new Date(activity.timestamp);
                           return `${date.toLocaleDateString()},${date.toLocaleTimeString()},${activity.leadName},${activity.leadEmail},${activity.azione},${activity.stato},"${activity.dettagli}"`;
                       }).join('\n');
            
            downloadCSV(csv, `log-attivita-${new Date().toISOString().split('T')[0]}.csv`);
        };

        window.exportWeeklyReport = function() {
            const totalLeads = leads.length;
            const recoveredLeads = leads.filter(lead => lead.stato === 'lead-ok').length;
            const recoveryRate = totalLeads > 0 ? Math.round((recoveredLeads / totalLeads) * 100) : 0;
            
            const allActivities = leads.flatMap(lead => 
                (lead.attivita || []).filter(a => a.azione === 'Chiamata effettuata')
            );
            
            const weeklyStats = Object.keys(statusConfig).map(status => {
                const count = leads.filter(lead => lead.stato === status).length;
                const percentage = totalLeads > 0 ? Math.round((count / totalLeads) * 100) : 0;
                return `${statusConfig[status].label},${count},${percentage}%`;
            }).join('\n');
            
            const csv = `REPORT SETTIMANALE ROMINA - ${new Date().toLocaleDateString()}\n\n` +
                       `METRICHE GENERALI\n` +
                       `Lead Totali,${totalLeads}\n` +
                       `Lead Recuperati,${recoveredLeads}\n` +
                       `Tasso Recupero,${recoveryRate}%\n` +
                       `Chiamate Totali,${allActivities.length}\n\n` +
                       `DISTRIBUZIONE PIPELINE\n` +
                       `Stato,Quantit√†,Percentuale\n` +
                       weeklyStats;
            
            downloadCSV(csv, `report-settimanale-romina-${new Date().toISOString().split('T')[0]}.csv`);
        };

        window.exportMonthlyReport = function() {
            const totalLeads = leads.length;
            const recoveredLeads = leads.filter(lead => lead.stato === 'lead-ok').length;
            const recoveryRate = totalLeads > 0 ? Math.round((recoveredLeads / totalLeads) * 100) : 0;
            
            const allActivities = leads.flatMap(lead => 
                (lead.attivita || []).filter(a => a.azione === 'Chiamata effettuata')
            );

            const monthlyStats = Object.keys(statusConfig).map(status => {
                const count = leads.filter(lead => lead.stato === status).length;
                const percentage = totalLeads > 0 ? Math.round((count / totalLeads) * 100) : 0;
                return `${statusConfig[status].label},${count},${percentage}%`;
            }).join('\n');

            const csv = `REPORT MENSILE COMPLETO ROMINA - ${new Date().toLocaleDateString()}\n\n` +
                       `METRICHE GENERALI\n` +
                       `Lead Totali Processati,${totalLeads}\n` +
                       `Lead Recuperati con Successo,${recoveredLeads}\n` +
                       `Tasso di Recupero,${recoveryRate}%\n` +
                       `Chiamate Totali Effettuate,${allActivities.length}\n` +
                       `Media Chiamate per Lead,${totalLeads > 0 ? (allActivities.length / totalLeads).toFixed(1) : 0}\n\n` +
                       `DISTRIBUZIONE FINALE PIPELINE\n` +
                       `Stato,Quantit√†,Percentuale\n` +
                       monthlyStats + '\n\n' +
                       `COMMERCIALI PERFORMANCE\n` +
                       `Commerciale,Lead Assegnati,Lead Ok Ricevuti\n` +
                       commerciali.map(comm => {
                           const assigned = leads.filter(lead => lead.commerciale === comm).length;
                           const recovered = leads.filter(lead => lead.commerciale === comm && lead.stato === 'lead-ok').length;
                           return `${comm},${assigned},${recovered}`;
                       }).join('\n');
            
            downloadCSV(csv, `report-mensile-completo-${new Date().toISOString().split('T')[0]}.csv`);
        };

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Archive and cleanup functions - placeholders
        window.showArchiveOptions = function() {
            alert('üöß Funzione Archiviazione in sviluppo');
        };

        window.showCleanupOptions = function() {
            alert('üöß Funzione Pulizia in sviluppo');
        };

        window.closeArchiveModal = function() {
            document.getElementById('archiveModal').style.display = 'none';
        };

        window.closeCleanupModal = function() {
            document.getElementById('cleanupModal').style.display = 'none';
        };

        // Event listeners
        document.getElementById('add-lead-form').addEventListener('submit', function(e) {
            e.preventDefault();
            addNewLead();
        });

        document.getElementById('search-input').addEventListener('input', function() {
            renderLeads();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const leadModal = document.getElementById('leadModal');
            const commercialModal = document.getElementById('commercialModal');
            const archiveModal = document.getElementById('archiveModal');
            const cleanupModal = document.getElementById('cleanupModal');
            
            if (event.target == leadModal) {
                leadModal.style.display = "none";
            }
            if (event.target == commercialModal) {
                closeCommercialModal();
            }
            if (event.target == archiveModal) {
                archiveModal.style.display = "none";
            }
            if (event.target == cleanupModal) {
                cleanupModal.style.display = "none";
            }
        };

        // Drag and drop for file upload
        const importArea = document.getElementById('import-area');
        
        importArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            importArea.classList.add('dragover');
        });
        
        importArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            importArea.classList.remove('dragover');
        });
        
        importArea.addEventListener('drop', function(e) {
            e.preventDefault();
            importArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });

        // Initialize app when DOM is loaded
        initApp();
    </script>
</body>
</html>
